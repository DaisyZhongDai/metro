<html>
<head>
	<title>Shanghai Metro</title>
	<script type="text/javascript" src="d3.min.js"></script>
	<style type="text/css">
/*		#clock {
			font-family: sans-serif;
			font-size: 1.5em;
			font-weight: 300;
			color: "grey";
		}*/
		.bar {
  			fill: #9056a3;
		}

		.axis text {
  			font: 10px sans-serif;
		}

		.axis path,
		.axis line {
		  	fill: none;
		  	stroke: #000;
		  	shape-rendering: crispEdges;
		}

		/*.x.axis path {
		  	display: none;
		}*/
	</style>
</head>
<body>
<div>
	<svg id="passengers"></svg>
</div>
<script>
	var stations = ["闵行开发区", "文井路", "华宁路", "金平路", "东川路", "剑川路", "北桥", "颛桥", "银都路", "春申路", "莘庄"];

	var data;

	// var data = [
	// 			[["07:00", "闵行开发区", 20], ["06:00", "文井路", 10], ["05:00", "颛桥", 30], ["04:00", "春申路", 50]],
	// 			[["08:00", "闵行开发区", 40], ["07:00", "文井路", 20], ["06:00", "华宁路", 10], ["05:00", "剑川路", 10], ["04:00", "莘庄", 50]],
	// 			[["09:00", "闵行开发区", 30], ["08:00", "文井路", 20], ["07:00", "金平路", 10], ["06:00", "东川路", 20], ["05:00", "北桥", 15], ["04:00", "莘庄", 0]],
	// 			[["10:00", "闵行开发区", 30], ["09:00", "文井路", 20], ["08:00", "金平路", 10], ["07:00", "东川路", 20], ["06:00", "北桥", 20], ["05:00", "莘庄", 0]]
	// 		];

	// var data = [[[420, 420, [["闵行开发区", "闵行开发区"], 0], 50]], [[421, 420, [["闵行开发区", "文井路"], 0.5], 50]], [[422, 420, [["文井路", "文井路"], 0], 62]], [[423, 420, [["文井路", "华宁路"], 0.5], 62]], [[424, 420, [["华宁路", "华宁路"], 0], 190]], [[425, 420, [["华宁路", "金平路"], 0.33], 190], [425, 425, [["闵行开发区", "闵行开发区"], 0], 73]], [[426, 420, [["华宁路", "金平路"], 0.67], 190], [426, 425, [["闵行开发区", "文井路"], 0.5], 73]], [[427, 420, [["金平路", "金平路"], 0], 347], [427, 425, [["文井路", "文井路"], 0], 89]], [[428, 420, [["金平路", "东川路"], 0.5], 347], [428, 425, [["文井路", "华宁路"], 0.5], 89]], [[429, 420, [["东川路", "东川路"], 0], 539], [429, 425, [["华宁路", "华宁路"], 0], 195]], [[430, 420, [["东川路", "剑川路"], 0.5], 539], [430, 425, [["华宁路", "金平路"], 0.33], 195], [430, 430, [["闵行开发区", "闵行开发区"], 0], 67]], [[431, 420, [["剑川路", "剑川路"], 0], 678], [431, 425, [["华宁路", "金平路"], 0.67], 195], [431, 430, [["闵行开发区", "文井路"], 0.5], 67]], [[432, 420, [["剑川路", "北桥"], 0.33], 678], [432, 425, [["金平路", "金平路"], 0], 345], [432, 430, [["文井路", "文井路"], 0], 79]], [[433, 420, [["剑川路", "北桥"], 0.67], 678], [433, 425, [["金平路", "东川路"], 0.5], 345], [433, 430, [["文井路", "华宁路"], 0.5], 79]], [[434, 420, [["北桥", "北桥"], 0], 874], [434, 425, [["东川路", "东川路"], 0], 594], [434, 430, [["华宁路", "华宁路"], 0], 258]], [[435, 420, [["北桥", "颛桥"], 0.25], 874], [435, 425, [["东川路", "剑川路"], 0.5], 594], [435, 430, [["华宁路", "金平路"], 0.33], 258], [435, 435, [["闵行开发区", "闵行开发区"], 0], 81]], [[436, 420, [["北桥", "颛桥"], 0.5], 874], [436, 425, [["剑川路", "剑川路"], 0], 696], [436, 430, [["华宁路", "金平路"], 0.67], 258], [436, 435, [["闵行开发区", "文井路"], 0.5], 81]], [[437, 420, [["北桥", "颛桥"], 0.75], 874], [437, 425, [["剑川路", "北桥"], 0.33], 696], [437, 430, [["金平路", "金平路"], 0], 435], [437, 435, [["文井路", "文井路"], 0], 98]], [[438, 420, [["颛桥", "颛桥"], 0], 1038], [438, 425, [["剑川路", "北桥"], 0.67], 696], [438, 430, [["金平路", "东川路"], 0.5], 435], [438, 435, [["文井路", "华宁路"], 0.5], 98]], [[439, 420, [["颛桥", "银都路"], 0.33], 1038], [439, 425, [["北桥", "北桥"], 0], 844], [439, 430, [["东川路", "东川路"], 0], 666], [439, 435, [["华宁路", "华宁路"], 0], 234]], [[440, 420, [["颛桥", "银都路"], 0.67], 1038], [440, 425, [["北桥", "颛桥"], 0.25], 844], [440, 430, [["东川路", "剑川路"], 0.5], 666], [440, 435, [["华宁路", "金平路"], 0.33], 234], [440, 440, [["闵行开发区", "闵行开发区"], 0], 92]], [[441, 420, [["银都路", "银都路"], 0], 1122], [441, 425, [["北桥", "颛桥"], 0.5], 844], [441, 430, [["剑川路", "剑川路"], 0], 775], [441, 435, [["华宁路", "金平路"], 0.67], 234], [441, 440, [["闵行开发区", "文井路"], 0.5], 92]], [[442, 420, [["银都路", "春申路"], 0.5], 1122], [442, 425, [["北桥", "颛桥"], 0.75], 844], [442, 430, [["剑川路", "北桥"], 0.33], 775], [442, 435, [["金平路", "金平路"], 0], 415], [442, 440, [["文井路", "文井路"], 0], 100]], [[443, 420, [["春申路", "春申路"], 0], 1186], [443, 425, [["颛桥", "颛桥"], 0], 1054], [443, 430, [["剑川路", "北桥"], 0.67], 775], [443, 435, [["金平路", "东川路"], 0.5], 415], [443, 440, [["文井路", "华宁路"], 0.5], 100]], [[444, 420, [["春申路", "莘庄"], 0.5], 1186], [444, 425, [["颛桥", "银都路"], 0.33], 1054], [444, 430, [["北桥", "北桥"], 0], 940], [444, 435, [["东川路", "东川路"], 0], 622], [444, 440, [["华宁路", "华宁路"], 0], 241]], [[445, 420, [["莘庄", "莘庄"], 0], 1186], [445, 425, [["颛桥", "银都路"], 0.67], 1054], [445, 430, [["北桥", "颛桥"], 0.25], 940], [445, 435, [["东川路", "剑川路"], 0.5], 622], [445, 440, [["华宁路", "金平路"], 0.33], 241], [445, 445, [["闵行开发区", "闵行开发区"], 0], 80]], [[446, 425, [["银都路", "银都路"], 0], 1124], [446, 430, [["北桥", "颛桥"], 0.5], 940], [446, 435, [["剑川路", "剑川路"], 0], 721], [446, 440, [["华宁路", "金平路"], 0.67], 241], [446, 445, [["闵行开发区", "文井路"], 0.5], 80]], [[447, 425, [["银都路", "春申路"], 0.5], 1124], [447, 430, [["北桥", "颛桥"], 0.75], 940], [447, 435, [["剑川路", "北桥"], 0.33], 721], [447, 440, [["金平路", "金平路"], 0], 410], [447, 445, [["文井路", "文井路"], 0], 96]], [[448, 425, [["春申路", "春申路"], 0], 1199], [448, 430, [["颛桥", "颛桥"], 0], 1109], [448, 435, [["剑川路", "北桥"], 0.67], 721], [448, 440, [["金平路", "东川路"], 0.5], 410], [448, 445, [["文井路", "华宁路"], 0.5], 96]], [[449, 425, [["春申路", "莘庄"], 0.5], 1199], [449, 430, [["颛桥", "银都路"], 0.33], 1109], [449, 435, [["北桥", "北桥"], 0], 873], [449, 440, [["东川路", "东川路"], 0], 675], [449, 445, [["华宁路", "华宁路"], 0], 275]], [[450, 425, [["莘庄", "莘庄"], 0], 1199], [450, 430, [["颛桥", "银都路"], 0.67], 1109], [450, 435, [["北桥", "颛桥"], 0.25], 873], [450, 440, [["东川路", "剑川路"], 0.5], 675], [450, 445, [["华宁路", "金平路"], 0.33], 275], [450, 450, [["闵行开发区", "闵行开发区"], 0], 77]], [[451, 430, [["银都路", "银都路"], 0], 1202], [451, 435, [["北桥", "颛桥"], 0.5], 873], [451, 440, [["剑川路", "剑川路"], 0], 777], [451, 445, [["华宁路", "金平路"], 0.67], 275], [451, 450, [["闵行开发区", "文井路"], 0.5], 77]], [[452, 430, [["银都路", "春申路"], 0.5], 1202], [452, 435, [["北桥", "颛桥"], 0.75], 873], [452, 440, [["剑川路", "北桥"], 0.33], 777], [452, 445, [["金平路", "金平路"], 0], 438], [452, 450, [["文井路", "文井路"], 0], 95]], [[453, 430, [["春申路", "春申路"], 0], 1260], [453, 435, [["颛桥", "颛桥"], 0], 1047], [453, 440, [["剑川路", "北桥"], 0.67], 777], [453, 445, [["金平路", "东川路"], 0.5], 438], [453, 450, [["文井路", "华宁路"], 0.5], 95]], [[454, 430, [["春申路", "莘庄"], 0.5], 1260], [454, 435, [["颛桥", "银都路"], 0.33], 1047], [454, 440, [["北桥", "北桥"], 0], 950], [454, 445, [["东川路", "东川路"], 0], 667], [454, 450, [["华宁路", "华宁路"], 0], 203]], [[455, 430, [["莘庄", "莘庄"], 0], 1260], [455, 435, [["颛桥", "银都路"], 0.67], 1047], [455, 440, [["北桥", "颛桥"], 0.25], 950], [455, 445, [["东川路", "剑川路"], 0.5], 667], [455, 450, [["华宁路", "金平路"], 0.33], 203]], [[456, 435, [["银都路", "银都路"], 0], 1121], [456, 440, [["北桥", "颛桥"], 0.5], 950], [456, 445, [["剑川路", "剑川路"], 0], 766], [456, 450, [["华宁路", "金平路"], 0.67], 203]], [[457, 435, [["银都路", "春申路"], 0.5], 1121], [457, 440, [["北桥", "颛桥"], 0.75], 950], [457, 445, [["剑川路", "北桥"], 0.33], 766], [457, 450, [["金平路", "金平路"], 0], 367]], [[458, 435, [["春申路", "春申路"], 0], 1168], [458, 440, [["颛桥", "颛桥"], 0], 1128], [458, 445, [["剑川路", "北桥"], 0.67], 766], [458, 450, [["金平路", "东川路"], 0.5], 367]], [[459, 435, [["春申路", "莘庄"], 0.5], 1168], [459, 440, [["颛桥", "银都路"], 0.33], 1128], [459, 445, [["北桥", "北桥"], 0], 905], [459, 450, [["东川路", "东川路"], 0], 610]], [[460, 435, [["莘庄", "莘庄"], 0], 1168], [460, 440, [["颛桥", "银都路"], 0.67], 1128], [460, 445, [["北桥", "颛桥"], 0.25], 905], [460, 450, [["东川路", "剑川路"], 0.5], 610]], [[461, 440, [["银都路", "银都路"], 0], 1195], [461, 445, [["北桥", "颛桥"], 0.5], 905], [461, 450, [["剑川路", "剑川路"], 0], 743]], [[462, 440, [["银都路", "春申路"], 0.5], 1195], [462, 445, [["北桥", "颛桥"], 0.75], 905], [462, 450, [["剑川路", "北桥"], 0.33], 743]], [[463, 440, [["春申路", "春申路"], 0], 1260], [463, 445, [["颛桥", "颛桥"], 0], 1058], [463, 450, [["剑川路", "北桥"], 0.67], 743]], [[464, 440, [["春申路", "莘庄"], 0.5], 1260], [464, 445, [["颛桥", "银都路"], 0.33], 1058], [464, 450, [["北桥", "北桥"], 0], 877]], [[465, 440, [["莘庄", "莘庄"], 0], 1260], [465, 445, [["颛桥", "银都路"], 0.67], 1058], [465, 450, [["北桥", "颛桥"], 0.25], 877]], [[466, 445, [["银都路", "银都路"], 0], 1135], [466, 450, [["北桥", "颛桥"], 0.5], 877]], [[467, 445, [["银都路", "春申路"], 0.5], 1135], [467, 450, [["北桥", "颛桥"], 0.75], 877]], [[468, 445, [["春申路", "春申路"], 0], 1196], [468, 450, [["颛桥", "颛桥"], 0], 1022]], [[469, 445, [["春申路", "莘庄"], 0.5], 1196], [469, 450, [["颛桥", "银都路"], 0.33], 1022]], [[470, 445, [["莘庄", "莘庄"], 0], 1196], [470, 450, [["颛桥", "银都路"], 0.67], 1022]], [[471, 450, [["银都路", "银都路"], 0], 1095]], [[472, 450, [["银都路", "春申路"], 0.5], 1095]], [[473, 450, [["春申路", "春申路"], 0], 1164]], [[474, 450, [["春申路", "莘庄"], 0.5], 1164]], [[475, 450, [["莘庄", "莘庄"], 0], 1164]]];
	var intervalId;

	d3.json("trains.json", function(error, json){
		if (error) return console.warn(error);
		data = json;
		console.log("load success!");
		update();
    	var intervalId = setInterval(update, 1000);
	});

	var margin = {top: 20, right: 30, bottom: 30, left: 40},
	    width = 960 - margin.left - margin.right,
	    height = 300 - margin.top - margin.bottom;

	var x = d3.scale.ordinal().domain(stations)
	    .rangeRoundBands([0, width], .8);

	var y = d3.scale.linear().domain([0, 1200])
	    .range([height, 0]);

	var xAxis = d3.svg.axis()
	    .scale(x)
	    .orient("bottom");

	var yAxis = d3.svg.axis()
	    .scale(y)
	    .orient("left");

	var chart = d3.select("#passengers")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	  	.append("g")
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	chart.append("g")
      	.attr("class", "x axis")
      	.attr("transform", "translate(0," + height + ")")
      	.call(xAxis);

  	chart.append("g")
      	.attr("class", "y axis")
      	.call(yAxis);

  	// chart.selectAll(".bar")
   //    	.data(data)
   //  	.enter().append("rect")
   //    	.attr("class", "bar")
   //    	.attr("x", function(d) { return x(d[0]); })
   //    	.attr("y", function(d) { return y(d[1]); })
   //    	.attr("height", function(d) { return height - y(d[1]); })
   //    	.attr("width", x.rangeBand());

// [[474, 450, [["春申路", "莘庄"], 0.5], 1164]]

function customized_x(d) {
	return (1-d[2][1])*x(d[2][0][0]) + d[2][1]*x(d[2][0][1]);
}

    function draw(oneTick){
    	var bars = chart.selectAll(".bar");
    	
      	var barUpdate = bars.data(oneTick, function(d) { return d[1]; });

      	barUpdate.transition()
      		.duration(1000)
      		.attr("x", customized_x)
      		.attr("y", function(d) { 
      			// console.log(d);
      			return y(d[3]); 
      		})
      		.attr("height", function(d) { return height - y(d[3]);} );

    	barUpdate.enter().append("rect")
	      	.attr("class", "bar")
	      	.attr("x", customized_x)
	      	.attr("y", function(d) { return y(0); })
	      	.attr("width", x.rangeBand())
	      	.attr("height", 0)
	      	.transition()
	      	.duration(1000)
	      	.attr("y", function(d) { return y(d[3]); })
	      	.attr("height", function(d) { return height - y(d[3]); });

      	barUpdate.exit().transition()
      		.duration(1000)
      		.attr("height", 0);

      	barUpdate.exit().remove();
    }

    function update(){
		var oneTick = data.shift();
		// console.log(oneTick);
		if (oneTick) {
			// minutes++;
			draw(oneTick);
			// setTimeout(update, 500);
		}
		else {
			stopAnimation();
		}
	}

	// var intervalId = setInterval(update, 1500);

	function stopAnimation(){
		clearInterval(intervalId);
		draw([]);
	}

</script>